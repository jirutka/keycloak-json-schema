#!/usr/bin/env node
// vim: set ts=2 sw=2 expandtab:

const FS = require('node:fs')

const { openapiSchemaToJsonSchema: toJsonSchema } = require('@openapi-contrib/openapi-schema-to-json-schema')
const JsonMergePatch = require('json-merge-patch')
const YAML = require('yaml')


const topLevelType = 'RealmRepresentation'

function parseFile (filepath) {
  const contents = FS.readFileSync(filepath, 'utf-8')
  try {
    if (filepath.endsWith('.yml') || filepath.endsWith('.yaml')) {
      return YAML.parse(contents)
    } else {
      return JSON.parse(contents)
    }
  } catch (err) {
    err.message = `${filepath}: ${err.message}`
    throw err
  }
}

function traverse (obj, visitor) {
  if (typeof obj === 'object' && obj != null) {
    for (const val of Object.values(obj)) {
      visitor(val)
      traverse(val, visitor)
    }
  }
  return obj
}

function main (argv) {
  if (argv.length < 1 || ['-h', '--help'].includes(argv[0])) {
    console.warn('Usage: convert <openapi> <merge-patch>...')
    process.exit(1)
  }

  const oApiSchema = parseFile(argv[0])

  let schemaUri
  let defs = Object.entries(oApiSchema.components.schemas).reduce((acc, [id, schema]) => {
    const jsonSchema = toJsonSchema(schema)

    // It's the same for all, so just save the last one.
    schemaUri = jsonSchema['$schema']
    delete jsonSchema['$schema']

    acc[id] = jsonSchema
    return acc
  }, {})

  // Fix unhandled inheritance.
  // https://github.com/dahag-ag/keycloak-openapi/issues/7
  Object.assign(
    defs.AuthenticationExecutionExportRepresentation.properties,
    defs.AbstractAuthenticationExecutionRepresentation.properties,
  )
  Object.assign(
    defs.PolicyRepresentation.properties,
    defs.AbstractPolicyRepresentation.properties,
  )

  for (const patchFile of argv.slice(1)) {
    const patch = parseFile(patchFile)
    defs = JsonMergePatch.apply(defs, patch)
  }

  const refIds = []
  traverse(defs, obj => {
    if (typeof obj !== 'object' || obj == null) {
      return
    }
    if ('$ref' in obj) {
      const ref = obj['$ref'].replace('#/components/schemas/', '#/$defs/')
      refIds.push(ref.replace(/^#\/.*\//, ''))
      obj['$ref'] = ref
    }
    if (obj.type === 'object' && 'properties' in obj) {
      obj.additionalProperties ??= false
    }
    if (obj.type === 'string' && Array.isArray(obj['enum'])) {
      // https://github.com/dahag-ag/keycloak-openapi/issues/4 (it's not fixed in older specs)
      obj['enum'] = obj['enum'].map(item => item.replace(/\(\d\)$/, ''))
    }
  })

  const missing = refIds.filter(id => !defs[id])
  if (missing.length > 0) {
    console.warn(`Missing references: ${missing.join(', ')}`)
    process.exit(1)
  }

  const bundle = {
    '$schema': schemaUri,
    ...defs[topLevelType],
    '$defs': defs,
  }
  delete bundle['$defs'][topLevelType]

  console.log(JSON.stringify(bundle, null, 2))
}

main(process.argv.slice(2))
